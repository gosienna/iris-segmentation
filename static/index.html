<!doctype html>
<head>
</head>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.2"></script>
<script src="opencv.js"></script>
<script src="opencv_processing.js"></script>
<body>
  <p id="message"></p><br>
  <input id="input" type="file">
  <button onclick="load_model()">load model</button>
  <button id='predict' onclick="predict()" >predict</button>
  <button id='opencv' onclick='opencv()'>find iris</button><br>
  <img id='original' width="300" height="200" ></canvas>
  <canvas id="output" width="300" height="200"></canvas>
  <canvas id="iris" width="300" height="200"></canvas>
  <script >
  let model;
  document.getElementById('predict').style.visibility='hidden'
  document.getElementById('opencv').style.visibility='hidden' //set predict button hidden
  let inputElement=document.getElementById('input')
  inputElement.onchange = function() {
          imgElement=document.getElementById('original')
          imgElement.src = URL.createObjectURL(event.target.files[0]);
          /*
          var c = document.getElementById("original");

          var ctx = c.getContext("2d");
          var img = new Image();
          img.src = URL.createObjectURL(event.target.files[0]);
          img.onload = function () {
                       ctx.drawImage(img, 0, 0);
          */

          };

          //imgElement.src = URL.createObjectURL(event.target.files[0]);

  function load_model(){

     function show_predict_button(){
       console.log(document.getElementById('predict').style.visibility)
       document.getElementById('predict').style.visibility='visible';

     }
     async function load(show_predict_button){ //use callback function, show predict button when model loading is completed
       model = await tf.loadLayersModel('model/model.json');
       console.log('model loading success!')
       show_predict_button()
     }
     load(show_predict_button)

  }

  async function predict(){
     let x = tf.browser.fromPixels(document.getElementById('original')).asType('float32');
     scal=tf.scalar(1/255,'float32');
     x=tf.mul(x,scal);
     //x.print();

     x=tf.expandDims(x,0);
     function draw(y){
     y=tf.squeeze(y,0);
     y.print()
     //scal=tf.max(y)
     //y=tf.div(y,scal);
     //get_max_value(y);
     tf.browser.toPixels(y,document.getElementById('output'));
     document.getElementById('opencv').style.visibility='visible';
     }
     async function calculate(x,draw){
        y=await model.predict(x);
        draw(y)
     }
     calculate(x,draw);

  }
  function get_max_value(x){
    max_value=tf.max(x)
    document.getElementById("message").innerHTML=max_value.toString();
  }
  </script>
</body>
